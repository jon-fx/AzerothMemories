@page "/"
@inject IAccountServices _accountServices;
@inject ClientAuthHelper _clientAuthHelper
@using AzerothMemories.Services
@inherits ComputedStateComponent<AzerothMemories.Services.AccountViewModel?>

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

<MudButton OnClick="@(() => SignIn("BattleNet-Europe"))">Sign In</MudButton>
<MudButton OnClick="@(() => SignIn("BattleNet-UnitedStates"))">Sign In</MudButton>
<MudButton OnClick="SignOut">Sign Out</MudButton>

Welcome to your new app.

<AuthorizeView>
	<Authorized>
		<MudText Color="Color.Tertiary">Authorized</MudText>
		<MudText Color="Color.Tertiary">@_clientAuthHelper.Session.Id</MudText>
		<MudText Color="Color.Tertiary">@_clientAuthHelper.Auth.GetSessionUser(_clientAuthHelper.Session).Result.Name</MudText>
	</Authorized>
	<NotAuthorized>
		<MudText Color="Color.Error">NotAuthorized</MudText>
		<MudText Color="Color.Error">@_clientAuthHelper.Session.Id</MudText>
	</NotAuthorized>
</AuthorizeView>

@{
	var state = State.Value;
	if (state != null)
	{
		<MudText Color="Color.Warning">State: </MudText>
		<MudText Color="Color.Warning">@state.Username</MudText>
	}
	else
	{
		<MudText Color="Color.Warning">State: NULL </MudText>
	}

	<MudButton OnClick="@(() => Tests("Lightfx" + Random.Shared.NextInt64(0, 100000)))">Sign In</MudButton>
}

@code
{
	private async Task SignIn(string str)
	{
		await _clientAuthHelper.SignIn(str);
	}

	private async Task SignOut()
	{
		await _clientAuthHelper.SignOut();
	}

	protected override async Task<AccountViewModel?> ComputeState(CancellationToken cancellationToken)
	{
		var account = await _accountServices.TryGetAccount(1);
		return account;
	}

	private async Task Tests(string newUsername)
	{
		await _accountServices.TryChangeUsername(newUsername);
	}
}