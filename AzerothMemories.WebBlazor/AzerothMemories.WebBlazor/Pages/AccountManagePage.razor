@page "/accountmanage"
@inherits MoaComponentBase<AccountManagePageViewModel>

<PageTitle>Manage Account - Memories of Azeroth</PageTitle>

<AuthorizeView>
    @if (ViewModel != null && ViewModel.AccountViewModel != null)
    {
        <MudCard Class="pa-2 ma-2 card" Outlined="true" Elevation="10">
            <MudCardHeader>
                <CardHeaderAvatar>
                    <MudAvatar Size="Size.Large" Image="@ViewModel.AccountViewModel.Avatar">@ViewModel.AccountViewModel.GetAvatarText()</MudAvatar>
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Manage Account</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="6">
                        <MudTextField T="string"
                                      Label="Username"
                                      @bind-Value="ViewModel.NewUsername"
                                      Disabled="!ViewModel.AccountViewModel.CanChangeUsername"
                                      Adornment="Adornment.End"
                                      AdornmentIcon=@ViewModel.NewUsernameTextBoxAdornmentIcon
                                      AdornmentColor=@ViewModel.NewUsernameTextBoxAdornmentColor
                                      DebounceInterval="500"
                                      OnDebounceIntervalElapsed="ViewModel.OnNewUsernameTextChanged"
                                      MaxLength="49"/>
                    </MudItem>
                    <MudItem xs="6" Class="my-auto">
                        @if (ViewModel.ChangeUsernameButtonVisible)
                        {
                            <MudButton Variant="Variant.Filled" Disabled="!ViewModel.NewUsernameValid" FullWidth="true" OnClick="ViewModel.OnChangeUsernameClicked">Change Username</MudButton>
                        }
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField T="string" Label="Battle Tag" @bind-Value="ViewModel.AccountViewModel.BattleTag" Disabled="true" MaxLength="49"/>
                    </MudItem>
                    <MudItem xs="6" Class="my-auto">
                        <MudSwitch T="bool" Checked="@ViewModel.AccountViewModel.BattleTagIsPublic" Color="Color.Primary" Label="Public" CheckedChanged="ViewModel.OnBattleTagVisibilityChanged"/>
                    </MudItem>
                    <MudItem xs="6">
                        <MudSelect T="(string Link, string Name, long Id)" @bind-Value="@ViewModel.Avatar" Label="Avatar" Dense="true" OffsetY="true">
                            @{
                                foreach (var av in ViewModel.AllAvatars)
                                {
                                    var id = $"avatar-{av.Key}";
                                    <MudSelectItem @key="@id" Value="@av.Value">
                                        <div class="d-flex justify-start align-center">
                                            <MudAvatar Class="mr-3" Size="Size.Small" Image="@av.Value.Link">@av.Value.Name[0]</MudAvatar><MudText Inline="true">@av.Value.Name</MudText>
                                        </div>
                                    </MudSelectItem>
                                }
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="3" Class="my-auto">
                        <MudButton Variant="Variant.Filled" FullWidth="true">TODO UPLOAD</MudButton>
                    </MudItem>
                    <MudItem xs="3" Class="my-auto">
                        <MudButton Variant="Variant.Filled" FullWidth="true" OnClick="ViewModel.OnChangeAvatarClicked">Change</MudButton>
                    </MudItem>
                    <MudItem xs="12">
                        <MudSwitch T="bool" Checked="@ViewModel.AccountViewModel.IsPrivate" Color="Color.Primary" Label="Private" CheckedChanged="ViewModel.OnIsPrivateChanged"/>
                    </MudItem>

                    @foreach (var link in SocialHelpers.All)
                    {
                        <MudItem xs="6" Class="d-flex align-baseline">
                            <img src="@link.SocialIconLink" width="18" height="18" />
                            <MudTextField T="string"
                                          Class="px-2"
                                          Value="@ViewModel.SocialLinks[link.LinkId]"
                                          Label="@link.Name"
                                          Adornment="Adornment.End"
                                          AdornmentIcon=@ViewModel.SocialLinksAdornmentIcons[link.LinkId]
                                          AdornmentColor=@ViewModel.SocialLinksAdornmentColors[link.LinkId]
                                          ValueChanged="x => ViewModel.OnSocialLinkChanged(link, x)"
                                          MaxLength="49" />
                        </MudItem>
                        <MudItem xs="6">
                        </MudItem>
                    }
                </MudGrid>

            </MudCardContent>
        </MudCard>
        <MudCard Class="pa-2 ma-2 card" Outlined="true" Elevation="10">
            <MudCardHeader>
                <CardHeaderAvatar>
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Manage Characters</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudSimpleTable Hover="true" Dense="true" Striped="true" Breakpoint="Breakpoint.None">
                    <thead>
                    <tr>
                        <MudTh></MudTh>

                        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                            <MudTh>Name</MudTh>
                            <MudTh>Realm</MudTh>
                            <MudTh>Race</MudTh>
                            <MudTh>Class</MudTh>
                            <MudTh>Level</MudTh>
                        </MudHidden>

                        <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
                            <MudTh>Name</MudTh>
                        </MudHidden>

                        <MudTh>Sync</MudTh>
                        <MudTh>Result</MudTh>
                    </tr>
                    </thead>
                    <tbody>
                    @{
                        var characters = ViewModel.AccountViewModel.CharactersArray.OrderByDescending(x => x.Level).ThenBy(x => x.Name).ToArray();
                        @foreach (var row in characters)
                        {
                            <tr @key="row.Id">
                                <MudTd>
                                    <MudAvatar Size="Size.Medium" Image="@row.AvatarLinkWithFallBack"/>
                                </MudTd>
                                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                                    <MudTd DataLabel="Name">
                                        <CharacterNameLinkComponent CharacterName="@row.Name"
                                                                    CharacterClass="@row.Class"
                                                                    CharacterRealmId="@row.RealmId"
                                                                    CharacterRegionInfo="@row.RegionId.ToInfo()"/>
                                    </MudTd>
                                    <MudTd DataLabel="Realm">
                                        <RealmLinkComponent BlizzardRealmId="@row.RealmId"/>
                                    </MudTd>

                                    <MudTd DataLabel="Race">
                                        <CharacterRaceComponent CharacterRace="@row.Race"/>
                                    </MudTd>

                                    <MudTd DataLabel="Class">
                                        <CharacterClassComponent CharacterClass="@row.Class"/>
                                    </MudTd>

                                    <MudTd DataLabel="Level">
                                        @row.Level
                                    </MudTd>
                                </MudHidden>
                                <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
                                    <MudTd DataLabel="Name">
                                        <CharacterNameLinkComponent CharacterName="@row.Name"
                                                                    CharacterClass="@row.Class"
                                                                    CharacterRealmId="@row.RealmId"
                                                                    CharacterRegionInfo="@row.RegionId.ToInfo()"/>
                                                                    
                                        <div>
                                            <MudText Inline="true">@row.Level</MudText>
                                            <CharacterRaceComponent Inline="true" CharacterRace="@row.Race"/>
                                            <CharacterClassComponent Inline="true" CharacterClass="@row.Class"/>
                                        </div>

                                        <RealmLinkComponent BlizzardRealmId="@row.RealmId"/>
                                    </MudTd>
                                </MudHidden>

                                <MudTd DataLabel="Sync">
                                    <MudToggleIconButton Toggled="@row.AccountSync"
                                                         Icon="@Icons.Material.Filled.HourglassDisabled" Color="@Color.Error"
                                                         ToggledIcon="@Icons.Material.Filled.HourglassBottom" ToggledColor="@Color.Success"
                                                         ToggledChanged=@(x => ViewModel.OnAccountSyncToggleChanged(row, x))/>
                                </MudTd>

                                <MudTd DataLabel="Result">
                                    @row.LastUpdateHttpResult
                                </MudTd>
                            </tr>
                        }
                    }
                    </tbody>
                </MudSimpleTable>
            </MudCardContent>
        </MudCard>
    }
</AuthorizeView>